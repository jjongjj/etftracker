<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-width=1.0">
    <title>ETF Advanced Tracker Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --chart-bar: rgba(59, 130, 246, 0.5);
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header {
            width: 100%;
            padding: 2.5rem 1rem;
            text-align: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(15, 23, 42, 1) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            /* âœ… ì¶”ê°€ëœ í‘œì¤€ ì†ì„± */
            -webkit-text-fill-color: transparent;
            color: transparent;
            /* âœ… ì¶”ê°€ëœ í‘œì¤€ ì†ì„± */
        }

        .header p {
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-size: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 2rem 1rem;
            box-sizing: border-box;
        }

        .etf-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 2.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .etf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 1rem;
        }

        .etf-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #fff;
        }

        .etf-code {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        /* Gauge bar for Premium/Discount */
        .deviation-container {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .deviation-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .progress-bg {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            position: absolute;
            height: 100%;
            width: 50%;
            transition: all 1s ease;
        }

        /* 4-column Grid for main stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .stat-box h3 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            align-items: center;
        }

        .stock-item:last-child {
            border-bottom: none;
        }

        .s-name {
            font-weight: 500;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .val-up {
            color: var(--success);
            font-weight: 600;
        }

        .val-down {
            color: var(--danger);
            font-weight: 600;
        }

        .val-neu {
            color: var(--text-secondary);
        }

        /* Constituents full list */
        .full-list-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #e2e8f0;
        }

        .weights-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .weight-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .w-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }

        .w-bar-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .w-bar-fill {
            height: 100%;
            background: var(--chart-bar);
            border-radius: 3px;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .empty-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>Advanced ETF Tracker</h1>
        <p id="last-updated">Loading dynamic market data...</p>
    </div>

    <div class="container" id="dashboard-container">
        <div class="loader" id="loader"></div>
    </div>

    <script>
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        async function fetchDashboardData() {
            try {
                const response = await fetch(`dashboard_data.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error("Data not found");
                const data = await response.json();
                renderDashboard(data);
            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('dashboard-container').innerHTML = `<p style="text-align:center;color:var(--danger)">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }

        function renderDashboard(data) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('last-updated').innerHTML = `ê¸°ì¤€ì¼: <b>${data.business_day}</b> <span style="font-size:0.8rem; opacity:0.6">(Updated: ${data.last_updated})</span>`;

            const container = document.getElementById('dashboard-container');
            container.innerHTML = '';

            const etfs = Object.values(data.etfs);
            if (etfs.length === 0) {
                container.innerHTML = '<p style="text-align:center;">ì¶”ì  ì¤‘ì¸ ETFê°€ ì—†ìŠµë‹ˆë‹¤. (config.json í™•ì¸)</p>';
                return;
            }

            etfs.forEach(etf => {
                const card = document.createElement('div');
                card.className = 'etf-card';

                // Deviation logic
                let devColor = 'var(--success)';
                let devText = 'ì €í‰ê°€ (í• ì¸)';
                let pct = 50;
                let devValStr = etf.deviation.toFixed(2);

                if (etf.deviation > 0) {
                    devColor = 'var(--danger)';
                    devText = 'ê³ í‰ê°€ (í• ì¦)';
                    pct = 50 + Math.min(etf.deviation * 10, 50); // Scale logic for visual
                } else if (etf.deviation < 0) {
                    pct = 50 - Math.min(Math.abs(etf.deviation) * 10, 50);
                } else {
                    devText = 'ì ì •ì¹˜';
                }

                const devHtml = `
                    <div class="deviation-container">
                        <div class="deviation-title">
                            <span>NAV ëŒ€ë¹„ ê´´ë¦¬ìœ¨: <b style="color:${devColor}">${devValStr}%</b></span>
                            <span style="color:${devColor}">${devText}</span>
                        </div>
                        <div class="progress-bg">
                            <div class="progress-bar" style="width:${pct}%; background:${devColor}; ${etf.deviation > 0 ? 'left:50%; width:' + (pct - 50) + '%' : 'right:50%; width:' + (50 - pct) + '%'}"></div>
                            <div style="position:absolute; width:2px; height:10px; background:#fff; left:50%; top:-1px;"></div>
                        </div>
                    </div>
                `;

                // Additions/Deletions
                const adds = etf.recent_changes.added;
                const rems = etf.recent_changes.removed;
                let changesHtml = '';
                if (adds.length > 0 || rems.length > 0) {
                    changesHtml = `
                    <div class="stat-box" style="grid-column: 1 / -1; background: rgba(59, 130, 246, 0.1); border-color: var(--accent);">
                        <h3 style="color:var(--accent)">ğŸš¨ ìµœê·¼ í¸ì…/í¸ì¶œ ë°œìƒ</h3>
                        <div style="display:flex; gap: 2rem;">
                            <div style="flex:1"><b>í¸ì…:</b> ${adds.length > 0 ? adds.map(a => a.name).join(', ') : 'ì—†ìŒ'}</div>
                            <div style="flex:1"><b>í¸ì¶œ:</b> ${rems.length > 0 ? rems.map(a => a.name).join(', ') : 'ì—†ìŒ'}</div>
                        </div>
                    </div>
                    `;
                }

                // Gainers & Losers
                const gainersHtml = etf.gainers.map(g => `<li class="stock-item"><span class="s-name">${g.name}</span><span class="val-up">+${g.change_rate.toFixed(2)}%</span></li>`).join('');
                const losersHtml = etf.losers.map(l => `<li class="stock-item"><span class="s-name">${l.name}</span><span class="val-down">${l.change_rate.toFixed(2)}%</span></li>`).join('');

                // Net Purchases (unit: million won)
                const f_buysHtml = etf.foreign_buys.filter(f => f.net_foreign > 0).map(f => `<li class="stock-item"><span class="s-name">${f.name}</span><span class="val-neu">${formatNumber(Math.floor(f.net_foreign / 1000000))}M</span></li>`).join('') || '<div class="empty-text">ìˆœë§¤ìˆ˜ ì—†ìŒ</div>';
                const i_buysHtml = etf.inst_buys.filter(i => i.net_institutional > 0).map(i => `<li class="stock-item"><span class="s-name">${i.name}</span><span class="val-neu">${formatNumber(Math.floor(i.net_institutional / 1000000))}M</span></li>`).join('') || '<div class="empty-text">ìˆœë§¤ìˆ˜ ì—†ìŒ</div>';

                // Top 10 weights
                const weightsHtml = etf.top_weights.map(w => `
                    <div class="weight-card">
                        <div class="w-header">
                            <span style="font-weight:600">${w.name}</span>
                            <span style="color:var(--accent)">${w.weight.toFixed(2)}%</span>
                        </div>
                        <div class="w-bar-bg"><div class="w-bar-fill" style="width:${w.weight}%"></div></div>
                    </div>
                `).join('');


                card.innerHTML = `
                    <div class="etf-header">
                        <div>
                            <span class="etf-title">${etf.name}</span><span class="etf-code">(${etf.code})</span>
                        </div>
                        <div style="color:var(--text-secondary); font-size:0.9rem">ì´ ${etf.total_constituents} ì¢…ëª©</div>
                    </div>

                    ${devHtml}
                    ${changesHtml}

                    <div class="stats-grid">
                        <div class="stat-box">
                            <h3>ğŸŸ¢ ìƒìŠ¹ë¥  TOP 5</h3>
                            <ul class="stock-list">${gainersHtml}</ul>
                        </div>
                        <div class="stat-box">
                            <h3>ğŸ”´ í•˜ë½ë¥  TOP 5</h3>
                            <ul class="stock-list">${losersHtml}</ul>
                        </div>
                        <div class="stat-box">
                            <h3>ğŸ’µ ì™¸êµ­ì¸ ìˆœë§¤ìˆ˜ TOP 3 (ë°±ë§Œì›)</h3>
                            <ul class="stock-list">${f_buysHtml}</ul>
                        </div>
                        <div class="stat-box">
                            <h3>ğŸ¢ ê¸°ê´€ ìˆœë§¤ìˆ˜ TOP 3 (ë°±ë§Œì›)</h3>
                            <ul class="stock-list">${i_buysHtml}</ul>
                        </div>
                    </div>

                    <div class="full-list-title">ğŸ† ì‹œê°€ì´ì•¡ ë¹„ì¤‘ TOP 10</div>
                    <div class="weights-container">
                        ${weightsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        fetchDashboardData();
    </script>
</body>

</html>